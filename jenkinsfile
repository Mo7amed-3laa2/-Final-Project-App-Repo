pipeline {
agent any

    stages {
        stage('Build') {
            steps {
                echo 'building the application...'
                echo "Get code from a GitHub repository at branch '${ env.BRANCH_NAME }'..."
                //git 'https://github.com/Mo7amed-3laa2/jenkins_nodejs_example.git'
                echo 'build simple-app docker image...........'
                sh "docker build --tag mohamedalaa98/simple-app-node:V2.${BUILD_ID} ."
                }
        }
        stage('Push') {
            steps {
                echo "push simple-app image to docker-hub"
                withCredentials([usernamePassword(credentialsId: 'dockerhub', passwordVariable: 'PASS', usernameVariable: 'USER')]) {
                sh "echo $PASS | docker login -u $USER --password-stdin"
                sh "docker push mohamedalaa98/simple-app-node:V2.${BUILD_ID}" 
                }
            }
        }
        stage('Deploy') {
            steps {
                echo 'Deploying the application...'
                sh "kubectl apply -f ./app-deployments-k8s/app-deployment.yml -n app"
                sh "kubectl apply -f ./app-deployments-k8s/app-service.yml -n app"
            }
            post {
                success {
                    //slackSend color: "good", message: "Build ${ BUILD_TAG } Succeeded !"
                    echo 'Succeeded'
                }
                failure {
                    //slackSend color: "danger", message: "Build ${ BUILD_TAG } Failed !!!"
                    echo 'Failed'
                }
            }  
        }               
    }
}